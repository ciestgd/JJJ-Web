<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä»»åŠ¡ç»“æœå±•ç¤º - äº¬æ´¥å†€æ–°ä¸€ä»£å¤§æ°”ç¯å¢ƒæ™ºèƒ½æ¨¡å‹ç³»ç»Ÿï¼ˆNEXT+ï¼‰</title>
    <script src="./utils/vue.global.js"></script>
    <script src="./utils/echarts.min.js"></script>
    <link rel="stylesheet" href="./utils/element-plus/index.css" />
    <link rel="stylesheet" href="./assets/styles/common.css" />
    <link rel="stylesheet" href="./utils/leaflet/leaflet.css" crossorigin="" />
    <script src="./utils/leaflet/leaflet.js" crossorigin=""></script>
    <!-- å¼•å…¥proj4ä¾èµ– -->
    <script src="./utils/proj4.js"></script>
    <script src="./utils/proj4leaflet.js"></script>
    <script src="./utils/element-plus/index.js"></script>
    <script src="./utils/echarts.min.js"></script>
    <link rel="stylesheet" href="./MapData/map.css" />
    <style>
      /* é¡µé¢æ ‡é¢˜ */
      .page-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-title {
        font-size: 2.5rem;
        color: #00eeff;
        text-shadow: 0 0 15px rgba(0, 238, 255, 0.5);
        margin-bottom: 10px;
      }

      .page-subtitle {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.7);
      }

      .task-info {
        background: rgba(25, 35, 70, 0.3);
        border: 1px solid rgba(0, 238, 255, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-details {
        display: flex;
        gap: 30px;
        align-items: center;
      }

      .task-detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .task-detail-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .task-detail-value {
        font-size: 1.1rem;
        color: #00eeff;
        font-weight: bold;
      }

      .back-btn {
        background: linear-gradient(45deg, #0066cc, #00eeff);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background: linear-gradient(45deg, #00eeff, #0066cc);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 238, 255, 0.3);
      }

      /* ç»“æœå±•ç¤ºåŒºåŸŸ */
      .results-container {
        width: 100%;
        flex: 1;
        /* overflow: hidden; */
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 10px;
        justify-content: flex-start;
        /* align-items: flex-start; */
      }

      .result-module {
        background: rgba(25, 35, 70, 0.3);
        border: 1px solid rgba(0, 238, 255, 0.3);
        border-radius: 15px;
        padding: 15px;
        transition: all 0.3s ease;
        overflow: hidden;
        cursor: pointer;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        width: calc((100% - 30px) / 3);
        height: calc(50% - 10px);
      }
      .result-module .result-module-header {
        width: 100%;
        height: 96px; /* å¢é«˜æ ‡é¢˜åŒºåŸŸä»¥å®¹çº³ä¸¤è¡Œæè¿° */
        box-sizing: border-box;
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œä¾¿äºæ˜¾ç¤ºä¸¤è¡Œæè¿° */
        padding-top: 10px;
        border-bottom: 1px solid rgba(0, 238, 255, 0.2);
        margin-bottom: 12px;
      }
      .module-title .module-description {
        margin-top: 6px;
        font-size: 13px; /* å­—ä½“æ›´å° */
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.2;
        max-height: 2.4em; /* æœ€å¤šæ˜¾ç¤ºä¸¤è¡Œ */
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-word;
      }

      .result-module:hover {
        border-color: #00eeff;
        box-shadow: 0 10px 30px rgba(0, 238, 255, 0.2);
        transform: translateY(-5px);
      }

      .result-module::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #00eeff, #0099cc, #00eeff);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .result-module:hover::before {
        opacity: 1;
      }

      .module-header {
        display: flex;
        align-items: center;
        gap: 15px;
        /* padding-bottom: 15px;  */
        /* margin-bottom: 20px;
        padding-bottom: 15px; */
        /* border-bottom: 1px solid rgba(0, 238, 255, 0.2); */
      }

      .module-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #00eeff, #0099cc);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .module-title {
        font-size: 1.4rem;
        color: #00eeff;
        font-weight: bold;
      }

      .module-content {
        width: 100%;
        flex: 1;
        box-sizing: border-box;
        background: rgba(10, 20, 50, 0.3);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(0, 238, 255, 0.1);
      }

      .vertical-heatmap-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .vertical-heatmap {
        width: 100%;
        height: 100%;
      }

      .vertical-heatmap-message {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0 24px;
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        background: rgba(5, 15, 35, 0.65);
        backdrop-filter: blur(2px);
        font-size: 0.95rem;
        line-height: 1.6;
      }

      /* æ·»åŠ è¿›å…¥è¯¦æƒ…çš„æç¤º */
      .enter-detail {
        background: rgba(0, 238, 255, 0.2);
        color: #00eeff;
        padding: 8px 14px; /* æ›´å¤§çš„å†…è¾¹è· */
        border-radius: 16px;
        font-size: 0.9rem;
        width: 90px; /* ä¿è¯æŒ‰é’®æ˜¾ç¤ºå®Œæ•´ */
        text-align: center;
        align-self: flex-start; /* ä¸æ ‡é¢˜é¡¶éƒ¨å¯¹é½ */
        margin-top: 6px;
        opacity: 0;
        transition: opacity 0.24s ease, transform 0.18s ease;
      }

      .result-module:hover .enter-detail {
        opacity: 1;
        transform: translateY(-2px);
      }

      .chart-placeholder {
        color: rgba(255, 255, 255, 0.5);
        font-size: 1.1rem;
        text-align: center;
      }

      .chart-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
        animation: fadeIn 0.3s ease;
      }

      .chart-loading .spinner {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 3px solid rgba(0, 238, 255, 0.2);
        border-top-color: #00eeff;
        animation: spin 1s linear infinite;
      }

      .module-description {
        margin-top: 15px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      /* æ¨¡æ‹Ÿæ•°æ®å±•ç¤º */
      .data-visualization {
        background: linear-gradient(
          135deg,
          rgba(0, 238, 255, 0.1),
          rgba(0, 153, 204, 0.05)
        );
        border-radius: 10px;
        padding: 20px;
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .data-item {
        text-align: center;
        padding: 10px;
        background: rgba(0, 238, 255, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(0, 238, 255, 0.2);
      }

      .data-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 5px;
      }

      .data-value {
        font-size: 1.2rem;
        color: #00eeff;
        font-weight: bold;
      }

      .data-unit {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
      }

      /* æ€§èƒ½æŒ‡æ ‡è¡¨æ ¼ */
      .performance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .performance-table th,
      .performance-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid rgba(0, 238, 255, 0.2);
      }

      .performance-table th {
        background: rgba(0, 238, 255, 0.1);
        color: #00eeff;
        font-weight: bold;
      }

      .performance-table td {
        color: rgba(255, 255, 255, 0.8);
      }

      .performance-value {
        color: #00eeff;
        font-weight: bold;
      }

      /* åŒ–å­¦ç»„åˆ†å›¾è¡¨ */
      .component-chart {
        height: 200px;
        background: linear-gradient(
          135deg,
          rgba(0, 238, 255, 0.05),
          rgba(0, 153, 204, 0.02)
        );
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .pie-chart-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: conic-gradient(
          #00eeff 0deg 90deg,
          #0099cc 90deg 180deg,
          #006699 180deg 270deg,
          #003366 270deg 360deg
        );
        position: relative;
      }

      .pie-chart-placeholder::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: #0a0a2a;
        border-radius: 50%;
      }

      /* å‚ç›´åˆ†å¸ƒå›¾ */
      .vertical-profile {
        height: 200px;
        background: linear-gradient(
          to top,
          rgba(0, 238, 255, 0.1) 0%,
          rgba(0, 238, 255, 0.05) 50%,
          rgba(0, 238, 255, 0.02) 100%
        );
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }

      .altitude-lines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 39px,
          rgba(0, 238, 255, 0.2) 40px
        );
      }

      .profile-data {
        position: absolute;
        top: 20px;
        right: 20px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .results-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .task-details {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .task-info {
          flex-direction: column;
          gap: 20px;
          align-items: flex-start;
        }

        .data-grid {
          grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }

        .page-title {
          font-size: 2rem;
        }

        .nav-menu {
          display: none;
        }
      }

      #emissionMapContent,
      #spatialMapContent,
      #stationChartContent,
      #pm25Component {
        width: 100%;
        height: 100%;
        background: var(--bg-primary);
      }
      /* åŠ¨ç”»æ•ˆæœ */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .result-module {
        animation: fadeIn 0.6s ease;
      }

      .result-module:nth-child(1) {
        animation-delay: 0.1s;
      }

      .result-module:nth-child(2) {
        animation-delay: 0.2s;
      }

      .result-module:nth-child(3) {
        animation-delay: 0.3s;
      }

      .result-module:nth-child(4) {
        animation-delay: 0.4s;
      }

      .result-module:nth-child(5) {
        animation-delay: 0.5s;
      }
    </style>
  </head>

  <body>
    <div class="container" id="app">
      <!-- å¤´éƒ¨å¯¼èˆª -->
      <header>
        <div class="logo-section">
          <!-- <div class="logo">ğŸŒ</div> -->
          <div class="platform-name">
            äº¬æ´¥å†€æ–°ä¸€ä»£å¤§æ°”ç¯å¢ƒæ™ºèƒ½æ¨¡å‹ç³»ç»Ÿï¼ˆNEXT+ï¼‰
          </div>
        </div>

        <nav class="nav-menu">
          <a
            href="index.html"
            class="nav-item active"
            >é¦–é¡µ</a
          >
          <div class="nav-dropdown">
            <a href="#" class="nav-item dropdown-toggle">åº”ç”¨åœºæ™¯</a>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item">ç©ºæ°”è´¨é‡é¢„æŠ¥</a>
              <a href="#" class="dropdown-item">é‡æ±¡æŸ“åº”å¯¹</a>
              <a href="long-term-planning-setup.html" class="dropdown-item"
                >ä¸­é•¿æœŸè§„åˆ’</a
              >
            </div>
          </div>
          <div class="nav-dropdown">
            <a href="#" class="nav-item dropdown-toggle">æ¨¡å‹é›†æˆ</a>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item">æ°”è±¡æ¨¡å‹</a>
              <a href="#" class="dropdown-item">æ’æ”¾æ¸…å•</a>
              <a href="cmaq-setup-wizard.html" class="dropdown-item"
                >åŒ–å­¦ä¼ è¾“</a
              >
              <a href="#" class="dropdown-item">æº¯æºæ¨¡å‹</a>
              <a href="#" class="dropdown-item">é¢„æŠ¥æ¨¡å‹</a>
              <a href="#" class="dropdown-item">è°ƒæ§æ¨¡å‹</a>
            </div>
          </div>
          <div class="nav-dropdown">
            <a href="#" class="nav-item dropdown-toggle">ä»»åŠ¡è°ƒåº¦</a>
            <div class="dropdown-menu">
              <a href="task-management.html" class="dropdown-item">ä»»åŠ¡ç®¡ç†</a>
              <a href="#" class="dropdown-item">å®šæ—¶ä»»åŠ¡</a>
              <a href="#" class="dropdown-item">å®æ—¶è°ƒåº¦</a>
              <a href="#" class="dropdown-item">æ€§èƒ½ç›‘æ§</a>
            </div>
          </div>
          <div class="nav-dropdown">
            <a href="#" class="nav-item dropdown-toggle">æ•°æ®åˆ†æ</a>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item">æ•°æ®å¯è§†åŒ–</a>
              <a href="#" class="dropdown-item">ç»Ÿè®¡åˆ†æ</a>
              <a href="#" class="dropdown-item">è¶‹åŠ¿é¢„æµ‹</a>
              <a href="#" class="dropdown-item">æŠ¥å‘Šç”Ÿæˆ</a>
            </div>
          </div>
        </nav>

        <div class="user-section">
          <div class="user-info">
            <div class="user-avatar">U</div>
            <div class="username">
              ç”¨æˆ·: <span id="current-user">admin</span>
            </div>
          </div>
        </div>
      </header>
      <div class="container-main">
        <div style="text-align: right; margin-bottom: 10px">
          <a href="task-management.html" class="back-btn">è¿”å›ä»»åŠ¡ç®¡ç†</a>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="results-container">
          <!-- æ¨¡å—0: æ’æ”¾æ¸…å• -->
          <div class="result-module">
            <div class="result-module-header">
              <div class="module-header">
                <div class="module-icon">ğŸ­</div>
                <div class="module-title">
                  <h3 class="module-title">æ’æ”¾æ¸…å•</h3>
                  <div class="module-description">
                    å±•ç¤ºäº¬æ´¥å†€åŒºåŸŸå†…ä¸»è¦æ±¡æŸ“ç‰©æ’æ”¾çš„ç©ºé—´åˆ†å¸ƒç‰¹å¾ã€‚
                  </div>
                </div>
              </div>
              <div
                class="enter-detail"
                @click="openDetailModule('emissions-inventory')"
              >
                è¯¦æƒ… â†’
              </div>
            </div>

            <div class="module-content">
              <div id="emissionMapContent" ref="emissionMapContentRef"></div>
            </div>
          </div>

          <!-- æ¨¡å—1: æ±¡æŸ“ç‰©ç©ºé—´åˆ†å¸ƒåŠæ—¶ç©ºæ¼”åŒ– -->
          <div class="result-module">
            <div class="result-module-header">
              <div class="module-header">
                <div class="module-icon">ğŸŒ</div>
                <div class="module-title">
                  <h3 class="module-title">æ±¡æŸ“ç‰©ç©ºé—´åˆ†å¸ƒåŠæ—¶ç©ºæ¼”åŒ–</h3>
                  <div class="module-description">
                    å±•ç¤ºäº¬æ´¥å†€åŒºåŸŸå†…ä¸»è¦æ±¡æŸ“ç‰©çš„ç©ºé—´åˆ†å¸ƒç‰¹å¾ï¼ŒåŒ…æ‹¬æ±¡æŸ“ç‰©æµ“åº¦åœºã€ç«™ç‚¹æ•°æ®å åŠ ã€æ°”è±¡åœºå åŠ ç­‰åŠŸèƒ½ã€‚
                  </div>
                </div>
              </div>
              <div
                class="enter-detail"
                @click="openDetailModule('spatial-distribution')"
              >
                è¯¦æƒ… â†’
              </div>
            </div>

            <div class="module-content">
             <div id="spatialMapContent" ref="spatialMapContentRef"></div>
            </div>
          </div>

          <!-- æ¨¡å—2: æ¨¡å‹æ ¡éªŒåŠæ€§èƒ½è¯„ä¼° -->
          <div class="result-module">
            <div class="result-module-header">
              <div class="module-header">
                <div class="module-icon">ğŸ“Š</div>
                <div class="module-title">
                  <h3 class="module-title">æ¨¡å‹æ ¡éªŒåŠæ€§èƒ½è¯„ä¼°</h3>
                  <div class="module-description">
                    é€šè¿‡ä¸è§‚æµ‹æ•°æ®å¯¹æ¯”ï¼Œè¯„ä¼°æ¨¡å‹é¢„æµ‹ç²¾åº¦ï¼ŒåŒ…æ‹¬å„é¡¹ç»Ÿè®¡æŒ‡æ ‡å’Œè¯¦ç»†çš„å¯¹æ¯”åˆ†æå›¾è¡¨ã€‚
                  </div>
                </div>
              </div>
              <div
                class="enter-detail"
                @click="openDetailModule('model-validation')"
              >
                è¯¦æƒ… â†’
              </div>
            </div>

            <div class="module-content">
              <div id="stationChartContent" ref="stationChartContentRef"></div>
            </div>
          </div>

          <!-- æ¨¡å—3: PM2.5åŒ–å­¦ç»„åˆ†åˆ†æ -->
          <div class="result-module">
            <div class="result-module-header">
              <div class="module-header">
                <div class="module-icon">âš—ï¸</div>
                <div class="module-title">
                  <h3 class="module-title">PM2.5åŒ–å­¦ç»„åˆ†åˆ†æ</h3>
                  <div class="module-description">
                    åˆ†æPM2.5çš„åŒ–å­¦ç»„åˆ†æ„æˆï¼ŒåŒ…æ‹¬å„ç»„åˆ†çš„æ—¶ç©ºåˆ†å¸ƒç‰¹å¾å’Œæ¥æºè´¡çŒ®åˆ†æã€‚
                  </div>
                </div>
              </div>
              <div
                class="enter-detail"
                @click="openDetailModule('chemical-composition')"
              >
                è¯¦æƒ… â†’
              </div>
            </div>

            <div class="module-content">
              <div id="pm25Component" ref="pm25ComponentRef"></div>
            </div>
          </div>

          <!-- æ¨¡å—4: å‚ç›´æ¼”åŒ– -->
          <div class="result-module">
            <div class="result-module-header">
              <div class="module-header">
                <div class="module-icon">ğŸ“ˆ</div>
                <div class="module-title">
                  <h3 class="module-title">å‚ç›´æ¼”åŒ–</h3>
                  <div class="module-description">
                    å±•ç¤ºæ±¡æŸ“ç‰©åœ¨ä¸åŒé«˜åº¦å±‚çš„å‚ç›´åˆ†å¸ƒç‰¹å¾å’Œè¾¹ç•Œå±‚æ¼”åŒ–è¿‡ç¨‹ã€‚
                  </div>
                </div>
              </div>
              <div
                class="enter-detail"
                @click="openDetailModule('vertical-evolution-new')"
              >
                è¯¦æƒ… â†’
              </div>
            </div>

            <div
              id="verticalEvolution"
              class="module-content"
              style="display: flex; align-items: flex-start"
            >
              <div class="vertical-heatmap-container">
                <div id="verticalHeatmapChart" class="vertical-heatmap">
                  <!-- å‚ç›´å‰–é¢æ•°æ® -->
                </div>
                <div
                  id="verticalHeatmapMessage"
                  class="vertical-heatmap-message"
                >
                  PM2.5 å‚ç›´å‰–é¢æ•°æ®åŠ è½½ä¸­...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <p>&copy; 2024 äº¬æ´¥å†€æ–°ä¸€ä»£å¤§æ°”ç¯å¢ƒæ™ºèƒ½æ¨¡å‹ç³»ç»Ÿï¼ˆNEXT+ï¼‰. ç‰ˆæƒæ‰€æœ‰</p>
      </footer>
    </div>
    <script type="module">
      window.addEventListener("DOMContentLoaded", function () {
        // import * as echarts from './utils/echarts.min.js';
        // æ•°æ®æ–‡ä»¶ä¸ result-detail-vertical-evolution-new.html ä¿æŒä¸€è‡´
        // const DATA_URL =
        //   "./ctm_demo_resutl/ctm/filtered_PM25_components_7layers_steps49_72.json";
        // const DATA_URL =
        //   "./ctm_demo_resutl/ctm/five_layers_data_cn03_model_json/cn03_PM25_TOT_2024102500.json";
        const POLLUTANT = "PM25_TOT";
        const ROW_IDX = 147;
        const TIME_IDX = 0;
        const chartDom = document.getElementById("verticalHeatmapChart");
        chartDom.innerHTML = "";
        let chartInstance = null;
        const DATA_URL =
          "./ctm_demo_resutl/ctm/task_results/verticalHeatData_options.json";
        fetch(DATA_URL)
          .then((r) => r.json())
          .then((res) => {
            // const dataFull = res?.variables?.[POLLUTANT]?.data;
            // let timeData = dataFull?.[TIME_IDX];
            if (!res) {
              chartDom.innerHTML =
                '<div style="padding:24px;color:#ccc">æ— å¯ç”¨æ•°æ®</div>';
              return;
            }
            // const cols =
            //   (timeData[0] && timeData[0][0] && timeData[0][0].length) || 0;
            const cols = 499;
            // æ„é€  heatmap æ•°æ®ï¼šx=åˆ—ï¼Œy=å±‚
            // const heatData = res;
            // æ•°æ®yè½´æ•´ä½“ä¸Šç§»ä¸€æ ¼ï¼Œä»¥ä¾¿0åˆ»åº¦ç•™ç©º
            const heatData = res.map(item => [item[0], item[1] + 1, item[2]]);
            const layerCount = 10;
            // for (let layerIdx = 0; layerIdx < layerCount; layerIdx++) {
            //   const layerGrid = timeData[layerIdx];
            //   if (!layerGrid) continue;
            //   for (let colI = 0; colI < cols; colI++) {
            //     const v = layerGrid[ROW_IDX] && layerGrid[ROW_IDX][colI];
            //     const value = v === undefined || v === null ? NaN : Number(v);
            //     heatData.push([colI, layerIdx, isNaN(value) ? null : value]);
            //   }
            // }
            fetch("./ctm_demo_resutl/ctm/task_results/verticalHeatData_grid.json")
             .then((r) => r.json())
             .then((res2) => {
                const tdata = res2;

                const xLabels = Array.from({ length: cols }, (_, i) => `${tdata[i].lon.toFixed(1)}, ${tdata[i].lat.toFixed(1)}`);
                // const yLabels = Array.from(
                //   { length: layerCount },
                //   (_, i) => `ç¬¬${i+1}å±‚`
                // );
                const yLabels = [0, 200, 400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000];
                // chartDom.style.minHeight = '520px';
                chartInstance = echarts.init(chartDom, "dark");

                const valueArray = heatData
                  .filter((d) => d[2] !== null)
                  .map((d) => d[2]);
                const minVal = valueArray.length ? Math.min(...valueArray) : 0;
                const maxVal = valueArray.length ? Math.max(...valueArray) : 1;
                const colorList = [
                  // { min: -5, max: 0, color: "#FEFEFE" },
                  { min: 0, max: 5, color: "#DEF1FA" },
                  { min: 5, max: 10, color: "#BEE6F9" },
                  { min: 10, max: 15, color: "#9CD9F6" },
                  { min: 15, max: 20, color: "#80C0E6" },
                  { min: 20, max: 25, color: "#65A8D9" },
                  { min: 25, max: 30, color: "#478DC8" },
                  { min: 30, max: 35, color: "#479A9D" },
                  { min: 35, max: 40, color: "#48A673" },
                  { min: 40, max: 45, color: "#47B345" },
                  { min: 45, max: 50, color: "#83C54C" },
                  { min: 50, max: 55, color: "#C0D553" },
                  { min: 55, max: 60, color: "#F8E75B" },
                  { min: 60, max: 65, color: "#F6BE4A" },
                  { min: 65, max: 70, color: "#F5953A" },
                  { min: 70, max: 75, color: "#F36A29" },
                  { min: 75, max: 80, color: "#E95228" },
                  { min: 80, max: 85, color: "#DC3626" },
                  { min: 85, max: 90, color: "#D11E26" },
                  { min: 90, max: 95, color: "#BD1C21" },
                  { min: 95, max: 100, color: "#A6181D" },
                ];
                // åŸå§‹ colorList ä¸º 5 å•ä½æ­¥é•¿ï¼Œè¿™é‡Œåˆå¹¶ä¸º 10 å•ä½æ­¥é•¿ä»¥ç¼©å° visualMap
                const pieces = (function () {
                  const res = [];
                  for (let i = 0; i < colorList.length; i += 2) {
                    const a = colorList[i];
                    const b = colorList[i + 1] || a;
                    res.push({
                      min: a.min,
                      max: b.max,
                      label: `${a.min} - ${b.max}`,
                      color: a.color,
                    });
                  }
                  return res;
                })();
                // const option = {
                //   tooltip: {
                //     position: "top",
                //     formatter: function (params) {
                //       const x = params.data[0];
                //       const y = params.data[1];
                //       const val = params.data[2];
                //       return `åˆ—: ${x}<br/>å±‚: ${y}<br/>å€¼: ${
                //         val !== null ? Number(val).toFixed(4) : "N/A"
                //       }`;
                //     },
                //   },
                //   // grid: { top: 65, bottom: 65, left: 60, right: 120 },
                //   xAxis: {
                //     type: "category",
                //     data: xLabels,
                //     name: "åˆ—",
                //     splitArea: { show: false },
                //   },
                //   yAxis: {
                //     type: "category",
                //     data: yLabels,
                //     name: "å±‚",
                //     inverse: false,
                //   },
                //   visualMap: {
                //     type: "piecewise",
                //     pieces: pieces.length ? pieces : [{ min: minVal, max: maxVal }],
                //     orient: "vertical",
                //     right: 10,
                //     top: "center",
                //     inverse: false,
                //     textStyle: { color: "#fff" },
                //     outOfRange: { color: ["#FEFEFE", "#91161A"] },
                //   },
                //   series: [
                //     {
                //       name: "å‰–é¢",
                //       type: "heatmap",
                //       data: heatData,
                //       label: { show: false },
                //       emphasis: {
                //         itemStyle: { borderColor: "#000", borderWidth: 1 },
                //       },
                //     },
                //   ],
                // };
                const option = {
                  tooltip: {
                    confine: true,
                    position: "top",
                    formatter: function (params) {
                      const x = params.data[0];
                      const y = params.data[1];
                      const val = params.data[2];
                      return `åˆ—: ${x}<br/>é«˜åº¦: ${yLabels[y]}ç±³<br/>å€¼: ${val !== null ? Number(val).toFixed(2) : "N/A"}`;
                    },
                  },
                  grid: { top: 35, bottom: 20, left: 10, right: 90, containLabel: true },
                  xAxis: {
                    type: "category",
                    data: xLabels,
                    // ä¸æ˜¾ç¤º x è½´å³ä¾§çš„åç§°
                    splitArea: { show: false },
                  },
                  yAxis: {
                    type: "category",
                    data: yLabels,
                    name: "é«˜åº¦ï¼ˆç±³ï¼‰",
                    inverse: false,
                    position: 'left',
                    nameLocation: 'end',
                    nameGap: 10,
                    nameTextStyle: { color: '#fff', fontSize: 12 },
                    axisLabel: { color: '#fff', fontSize: 12, interval: 1 },
                  },
                  visualMap: {
                    type: "piecewise",
                    pieces: pieces.length
                      ? pieces
                      : [{ min: minVal, max: maxVal }],
                    orient: "vertical",
                    right: 6,
                    top: "center",
                    inverse: false,
                    textStyle: { color: "#fff", fontSize: 10 },
                    itemHeight: 10,
                    itemWidth: 10,
                    itemGap: 6,
                    outOfRange: { color: ["#FEFEFE", "#91161A"] },
                  },
                  series: [
                    {
                      name: "å‰–é¢",
                      type: "heatmap",
                      data: heatData,
                      label: { show: false },
                      emphasis: {
                        itemStyle: { borderColor: "#000", borderWidth: 1 },
                      },
                    },
                  ],
                };
                
                chartInstance.setOption(option);
                setTimeout(() => chartInstance.resize(), 100);
            })
            
          })
          .catch((e) => {
            console.log(e);
            chartDom.innerHTML =
              '<div style="padding:24px;color:#ccc">æ•°æ®åŠ è½½å¤±è´¥</div>';
          });
      });
    </script>
    <script type="module">
      import chinaGeoJson from "./MapData/china.js";
      import { MapComponent } from "./MapData/map-component.js";
      const { ElLoading } = ElementPlus;
      const { createApp, ref, onMounted, onUnmounted, watch, nextTick } = Vue;

      createApp({
        setup() {
          const DEFAULT_LAMBERT_DEF =
            "+proj=lcc +lat_1=25 +lat_2=45 +lon_0=105 +lat_0=35 +x_0=0 +y_0=0 +datum=WGS84  +units=m +no_defs";

          const createMapContext = () => ({
            containerRef: ref(null),
            mapComponent: null,
            mapInstance: ref(null),
            mapBounds: ref(null),
            mapMarkersLayer: ref(null),
            baseMapCorners: ref([]),
            lambertProjDef: ref(DEFAULT_LAMBERT_DEF),
            imgUrlData: ref([]),
            queryParams: ref({
              defaultData: "é»˜è®¤è¾“å‡ºæ•°æ®",
              pollutant: "PM25_TOT",
              time: 0,
              layer: "ç¬¬1å±‚",
            }),
          });

          const emissionMapCtx = createMapContext();
          const spatialMapCtx = createMapContext();

          const emissionMapContentRef = emissionMapCtx.containerRef;
          const spatialMapContentRef = spatialMapCtx.containerRef;

          const allPmData = ref([]);
          const stationChartContentRef = ref(null);
          const pm25ComponentRef = ref(null);
          const stationChart = ref(null);
          const pm25ComponentChart = ref(null);
          const isLambert = ref(true); // æ˜¯å¦ä¸ºå…°ä¼¯ç‰¹æŠ•å½±
          const allStationList = ref([]); // æ‰€æœ‰ç«™ç‚¹æ•°æ®
          const allStationData = ref({}); // æŒ‰ç«™ç‚¹ç¼–ç åˆ†ç»„çš„ç«™ç‚¹æ•°æ®
          const stationModelData = ref({});

          const pm25Loading = ref(null); // PM2.5 ç»„åˆ†å›¾è¡¨åŠ è½½çŠ¶æ€
          // æ±¡æŸ“ç‰©é€‰é¡¹
          const pollutantOptions = ref([
            { label: "PM2.5", value: "PM25_TOT", translate: 1 },
            { label: "NO2", value: "NO2", translate: 2.05 },
            { label: "O3", value: "O3", translate: 2.14 },
            { label: "SO2", value: "SO2", translate: 2.86 },
            { label: "CO", value: "CO", translate: 1.25 },
            { label: "PM10", value: "PM10", translate: 1 },
          ]);
          // é¢œè‰²é…ç½®
          const colorList = ref([
            { min: -5, max: 0, color: "#FEFEFE" },
            { min: 0, max: 5, color: "#DEF1FA" },
            { min: 5, max: 10, color: "#BEE6F9" },
            { min: 10, max: 15, color: "#9CD9F6" },
            { min: 15, max: 20, color: "#80C0E6" },
            { min: 20, max: 25, color: "#65A8D9" },
            { min: 25, max: 30, color: "#478DC8" },
            { min: 30, max: 35, color: "#479A9D" },
            { min: 35, max: 40, color: "#48A673" },
            { min: 40, max: 45, color: "#47B345" },
            { min: 45, max: 50, color: "#83C54C" },
            { min: 50, max: 55, color: "#C0D553" },
            { min: 55, max: 60, color: "#F8E75B" },
            { min: 60, max: 65, color: "#F6BE4A" },
            { min: 65, max: 70, color: "#F5953A" },
            { min: 70, max: 75, color: "#F36A29" },
            { min: 75, max: 80, color: "#E95228" },
            { min: 80, max: 85, color: "#DC3626" },
            { min: 85, max: 90, color: "#D11E26" },
            { min: 90, max: 95, color: "#BD1C21" },
            { min: 95, max: 100, color: "#A6181D" },
            { min: 100, max: 105, color: "#91161A" },
          ]);
          /**
           * æ ¹æ® IOAPI æ•°æ®å‚æ•°ï¼Œè®¡ç®— WGS84 åæ ‡ç³»çš„åœ°ç†è¾¹ç•Œ
           */
          function getWgs84BoundsFromIOAPI(ctx, ioapiData) {
            try {
              const {
                NCOLS,
                NROWS,
                XORIG,
                YORIG,
                XCELL,
                YCELL,
                P_ALP,
                P_BET,
                P_GAM,
                YCENT,
              } = ioapiData;

              // æ ¡éªŒå¿…è¦å‚æ•°
              const requiredParams = [
                NCOLS,
                NROWS,
                XORIG,
                YORIG,
                XCELL,
                YCELL,
                P_ALP,
                P_BET,
                P_GAM,
                YCENT,
              ];
              if (
                requiredParams.some(
                  (param) => param === undefined || param === null
                )
              ) {
                throw new Error("IOAPI æ•°æ®ç¼ºå°‘å¿…è¦çš„æŠ•å½±æˆ–èŒƒå›´å‚æ•°");
              }
              if (NCOLS <= 0 || NROWS <= 0 || XCELL <= 0 || YCELL <= 0) {
                throw new Error(
                  "NCOLS/NROWS/XCELL/YCELL å¿…é¡»ä¸ºæ­£æ•°ï¼ˆç½‘æ ¼å¤§å°æ— æ•ˆï¼‰"
                );
              }

              const xMin = XORIG;
              const xMax = XORIG + NCOLS * XCELL;
              const yMax = YORIG + NROWS * YCELL;
              const yMin = YORIG;

              const lccProjDef = `+proj=lcc +lat_1=${P_ALP} +lat_2=${P_BET} +lon_0=${P_GAM} +lat_0=${YCENT} +x_0=0 +y_0=0 +datum=WGS84  +units=m +no_defs`;
              ctx.lambertProjDef.value = lccProjDef;
              const projectToWGS84 = proj4(lccProjDef, "EPSG:4326");

              const corners = [
                [xMin, yMax], // å·¦ä¸Šè§’
                [xMax, yMax], // å³ä¸Šè§’
                [xMin, yMin], // å·¦ä¸‹è§’
                [xMax, yMin], // å³ä¸‹è§’
              ].map((coord) => projectToWGS84.forward(coord));
              console.log("corners---", corners);
              ctx.baseMapCorners.value = corners;
              return L.latLngBounds([
                [corners[0][1], corners[0][0]],
                [corners[3][1], corners[3][0]],
              ]);
            } catch (error) {
              return [];
            }
          }

          /**
           * å°†å•ä¸ªç½‘ç»œå›¾ç‰‡è·¯å¾„è½¬æ¢ä¸º Blob URL
           * @param {string} imageUrl - ç½‘ç»œå›¾ç‰‡è·¯å¾„
           * @returns {Promise<string|null>} - ç”Ÿæˆçš„ Blob URL æˆ– nullï¼ˆå¤±è´¥æ—¶ï¼‰
           */
          async function convertSingleImageToBlobUrl(imageUrl) {
            try {
              const response = await fetch(imageUrl);
              if (!response.ok) {
                throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
              }
              const blob = await response.blob();
              // éªŒè¯ Blob ç±»å‹æ˜¯å¦ä¸ºå›¾ç‰‡ï¼ˆå¯é€‰ï¼Œå¢å¼ºå¥å£®æ€§ï¼‰
              if (!blob.type.startsWith('image/')) {
                throw new Error(`èµ„æºä¸æ˜¯å›¾ç‰‡: ${blob.type}`);
              }
              return URL.createObjectURL(blob);
            } catch (error) {
              console.error(`å¤„ç†å›¾ç‰‡ ${imageUrl} å¤±è´¥:`, error.message);
              return null; // å•ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
            }
          }

          /**
           * æ‰¹é‡å°†å¤šä¸ªç½‘ç»œå›¾ç‰‡è·¯å¾„è½¬æ¢ä¸º Blob URL æ•°ç»„
           * @param {string[]} imageUrls - ç½‘ç»œå›¾ç‰‡è·¯å¾„æ•°ç»„
           * @returns {Promise<string[]>} - Blob URL æ•°ç»„ï¼ˆå¤±è´¥é¡¹ä¸º nullï¼‰
           */
          async function batchConvertImagesToBlobUrls(imageUrls) {
            if (!Array.isArray(imageUrls) || imageUrls.length === 0) {
              console.warn("è¯·ä¼ å…¥æœ‰æ•ˆçš„å›¾ç‰‡è·¯å¾„æ•°ç»„");
              return [];
            }

            // å¹¶è¡Œå¤„ç†æ‰€æœ‰å›¾ç‰‡ï¼Œè¿”å›ç»“æœæ•°ç»„
            const blobUrls = await Promise.all(
              imageUrls.map(url => convertSingleImageToBlobUrl(url))
            );

            return blobUrls;
          }

          const loadMapData = async (ctx) => {
            try {
              let global_attributes = {
                IOAPI_VERSION:
                  "ioapi-3.2: $Id: init3.F90 185 2020-08-28 16:49:45Z coats $ ",
                EXEC_ID: "???????????????? ",
                FTYPE: 1,
                CDATE: 2025293,
                CTIME: 32029,
                WDATE: 2025293,
                WTIME: 32029,
                SDATE: 2024296,
                STIME: 0,
                TSTEP: 10000,
                NTHIK: 1,
                NCOLS: 499,
                NROWS: 412,
                NLAYS: 14,
                NVARS: 148,
                GDTYP: 2,
                P_ALP: 25.0,
                P_BET: 45.0,
                P_GAM: 105.0,
                XCENT: 105.0,
                YCENT: 35.0,
                XORIG: 327000.0,
                YORIG: -145500.0,
                XCELL: 3000.0,
                YCELL: 3000.0,
                VGTYP: 7,
                VGTOP: 10000.0,
                VGLVLS: [
                  1.0, 0.993, 0.983, 0.97, 0.954, 0.934, 0.909, 0.88, 0.832,
                  0.784, 0.735, 0.604, 0.398, 0.207, 0.0,
                ],
                GDNAM: "M_03_ZZ ",
                UPNAM: "COMBINE ",
              };
              let result = await getWgs84BoundsFromIOAPI(ctx, global_attributes);
              ctx.mapBounds.value = result;

              let imgUrl = `${window.origin}/public/ctm_demo_resutl/ctm/1_layer_data_cn03_model_to_one_png/cn03_${ctx.queryParams.value.pollutant}_2024102800.png`;
              let _imgUrl = await convertSingleImageToBlobUrl(imgUrl);
              ctx.imgUrlData.value = [_imgUrl];
            } catch (error) {
              console.error("è·å–æ•°æ®å¤±è´¥:", error);
            }
          };

          const getColor = (value) => {
            if (value === null || value === undefined || isNaN(value)) {
              return "#000"; // ç¼ºå¤±å€¼é¢œè‰²
            }
            for (let i = 0; i < colorList.value.length; i++) {
              const range = colorList.value[i];
              if (value >= range.min && value <= range.max) {
                return range.color;
              }
            }
            // æ£€æŸ¥æ˜¯å¦æœ‰æ˜¯å¦è¶…å‡ºèŒƒå›´çš„é¢œè‰²å®šä¹‰
            if (value > colorList.value[0].max) {
              return colorList.value[0].color;
            } else if (
              value < colorList.value[colorList.value.length - 1].min
            ) {
              return colorList.value[colorList.value.length - 1].color;
            }
            return "#fff"; // è¶…å‡ºèŒƒå›´é¢œè‰²
          };
          const formatData = (value, pollutant, translateFactor) => {
            if (value === null || value === undefined || isNaN(value)) {
              return null; // ç¼ºå¤±å€¼
            }
            let targetValue = value * translateFactor;
            if (pollutant == "CO") {
              targetValue = targetValue / 1000; // COå•ä½è½¬æ¢ä¸º mg/m3
            }
            return targetValue;
          };
          const drawBaseMap = async (ctx) => {
            if (!ctx.mapComponent || !ctx.mapBounds.value) return;

            let data = ctx.imgUrlData.value || [];
            let timeData = data[ctx.queryParams.value.time];
            if (!timeData) return;

            let colorData = [...colorList.value].sort((a, b) => b.min - a.min);
            ctx.mapComponent.initCanvasDrawByImgUrl(
              timeData,
              colorData,
              20,
              ctx.mapBounds.value,
              false
            );
          };
          const focusOnDomain = (ctx) => {
            if (!ctx.mapInstance.value || !ctx.mapBounds.value) return;
            const bounds = ctx.mapBounds.value;
            const bestFitZoom = ctx.mapInstance.value.getBoundsZoom(bounds, true);
            const minZoom =
              typeof ctx.mapInstance.value.getMinZoom === "function"
                ? ctx.mapInstance.value.getMinZoom()
                : 0;
            const ZOOM_OFFSET = 1;
            const targetZoom = Math.max(bestFitZoom - ZOOM_OFFSET, minZoom);
            const center = bounds.getCenter();
            ctx.mapInstance.value.setView(center, targetZoom);
          };
          const initMap = (ctx) => {
            if (!ctx.containerRef.value) return;
            ctx.mapComponent = new MapComponent(ctx.containerRef.value, {
              isLambert: isLambert.value,
              lambertProjDef: ctx.lambertProjDef.value,
            });
            ctx.mapInstance.value = ctx.mapComponent.getMap();
            ctx.mapMarkersLayer.value = L.featureGroup().addTo(
              ctx.mapInstance.value
            );
          };
          // æ‰“å¼€è¯¦ç»†æ¨¡å—é¡µé¢
          const openDetailModule = (moduleType) => {
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get("taskId") || "demo-task-001";
            const taskName = urlParams.get("taskName") || "CMAQæ¨¡æ‹Ÿä»»åŠ¡";

            // æ„å»ºè¯¦ç»†é¡µé¢URL
            const detailUrl = `result-detail-${moduleType}.html?taskId=${taskId}&taskName=${encodeURIComponent(
              taskName
            )}&module=${moduleType}`;
            window.location.href = detailUrl;
          };

          const getStationData = async () => {
            try {
              let url =
                "./selected_station_data/station-data_extracted_20241104_to_20241123.json";
              let res = await fetch(url).then((response) => response.json());
              let list = res || [];
              allStationList.value = list;
              allStationData.value = Object.groupBy(
                list,
                (item) => item.stationCode
              );
            } catch (error) {
              console.error("è·å–ç«™ç‚¹æ•°æ®å¤±è´¥:", error);
              return {};
            }
          };
          const getStationModelData = async () => {
            let res = await fetch(
              "./ctm_demo_resutl/ctm/model_extracted_first1_layers_steps89_568/extracted_first1_layers_steps89_568_PM25_TOT.json"
            ).then((res) => res.json());
            let data = res || [];
            // å®šä¹‰è½¬æ¢è§„åˆ™æ˜ å°„è¡¨ï¼Œé”®ä¸ºæ±¡æŸ“ç‰©ç±»å‹ï¼Œå€¼ä¸ºè½¬æ¢å‡½æ•°
            const conversionRules = {
              O3: (value) => value * 2.14,
              SO2: (value) => value * 2.86,
              NO2: (value) => value * 2.05,
              CO: (value) => value * 1.25 * 1000, // åˆå¹¶è®¡ç®—æ­¥éª¤
            };
            // éå†æ•°æ®å¹¶åº”ç”¨è½¬æ¢è§„åˆ™
            for (const col in data) {
              // é¿å…éå†åŸå‹é“¾ä¸Šçš„å±æ€§
              if (!data.hasOwnProperty(col)) continue;

              const colData = data[col];
              for (const key in colData) {
                if (!colData.hasOwnProperty(key)) continue;

                const items = colData[key];
                for (const item of items) {
                  // å°†å€¼è§„èŒƒä¸ºæ•°å­—å¹¶ä¿ç•™ä¸¤ä½å°æ•°ï¼ˆè‹¥ä¸º null æˆ– éæ•° åˆ™ä¿æŒåŸæ ·ï¼‰
                  const _v = item.value ?? null;
                  if (_v !== null && !isNaN(_v)) {
                    item.value = parseInt(Number(_v), 10);
                  } else {
                    item.value = _v;
                  }
                }
                // // åªæœ‰å­˜åœ¨è½¬æ¢è§„åˆ™çš„keyæ‰éœ€è¦å¤„ç†
                // if (conversionRules.hasOwnProperty(key)) {
                //   const convert = conversionRules[key];
                //   for (const item of items) {
                //     const value = item.value ?? null; // æ›´ä¸¥è°¨çš„ç©ºå€¼å¤„ç†
                //     item.value = value !== null ? convert(value) : null;
                //   }
                // }
              }
            }
            stationModelData.value = data;
            console.log("stationModelData", stationModelData.value);
          };

          /**
           * å¤„ç†æ—¶é—´åºåˆ—æ•°æ®çš„é€šç”¨å·¥å…·å‡½æ•°
           * @param {Array} rawData - åŸå§‹æ•°æ®æ•°ç»„
           * @param {string} startTime - å¼€å§‹æ—¶é—´
           * @param {string} endTime - ç»“æŸæ—¶é—´
           * @param {Function} valueGetter - æå–å€¼çš„å‡½æ•°
           * @returns {Array} å¤„ç†åçš„æ—¶é—´åºåˆ—æ•°æ®
           */
          const processTimeSeriesData = (
            rawData,
            startTime,
            endTime,
            valueGetter
          ) => {
            if (!Array.isArray(rawData)) return [];
            let startTimestamp = new Date(startTime).getTime();
            let endTimestamp = new Date(endTime).getTime();
            return rawData
              .filter((item) => {
                let itemDate = new Date(item.date).getTime();
                return itemDate >= startTimestamp && itemDate <= endTimestamp;
              })
              .sort((a, b) => a.date - b.date)
              .map((item) => ({
                date: item.date,
                value: valueGetter(item),
              }));
          };

          /**
           * è·å–ç›‘æµ‹æ•°æ®
           * @param {string} stationCode - ç«™ç‚¹ç¼–ç 
           * @param {string} startTime - å¼€å§‹æ—¶é—´
           * @param {string} endTime - ç»“æŸæ—¶é—´
           * @param {string} pollutant - æ±¡æŸ“ç‰©ç±»å‹
           * @returns {Array} æ ¼å¼åŒ–çš„ç›‘æµ‹æ•°æ® [{date, value}, ...]
           */
          const getMonitorData = (
            stationCode,
            startTime,
            endTime,
            pollutant
          ) => {
            const rawData = allStationData.value[stationCode] ?? [];
            console.log("rawData", rawData, allStationData.value);
            return processTimeSeriesData(
              rawData,
              startTime,
              endTime,
              (item) => item[pollutant] // æå–ç›‘æµ‹å€¼çš„é€»è¾‘
            );
          };

          /**
           * è·å–æ¨¡æ‹Ÿæ•°æ®
           * @param {string} stationCode - ç«™ç‚¹ç¼–ç 
           * @param {number} startTime - å¼€å§‹æ—¶é—´æˆ³
           * @param {number} endTime - ç»“æŸæ—¶é—´æˆ³
           * @param {string} pollutant - æ±¡æŸ“ç‰©ç±»å‹
           * @returns {Array} æ ¼å¼åŒ–çš„æ¨¡æ‹Ÿæ•°æ® [{date, value}, ...]
           */
          const getModelData = (stationCode, startTime, endTime, pollutant) => {
            let modelName = pollutant == "PM2.5" ? "PM25_TOT" : pollutant;

            // ä½¿ç”¨å¯é€‰é“¾ç®€åŒ–æ·±å±‚å±æ€§è®¿é—®
            const rawModelData =
              stationModelData.value?.[stationCode]?.[modelName] ?? [];

            return processTimeSeriesData(
              rawModelData,
              startTime,
              endTime,
              (item) => item.value // æå–æ¨¡æ‹Ÿå€¼çš„é€»è¾‘
            );
          };

          /**
           * å›¾è¡¨æ ·å¼å¸¸é‡é…ç½®
           */
          const CHART_STYLES = {
            title: {
              text: "è§‚æµ‹å€¼ä¸æ¨¡æ‹Ÿå€¼æ—¶é—´åºåˆ—å¯¹æ¯”",
              left: "center",
              textStyle: { color: "#00eeff", fontSize: 18 },
            },
            legend: {
              data: ["è§‚æµ‹å€¼", "æ¨¡æ‹Ÿå€¼"],
              top: 35,
              textStyle: { color: "#fff", fontSize: 16 },
            },
            grid: {
              left: "5%",
              right: "4%",
              bottom: "8%",
              containLabel: true,
            },
            axis: {
              lineStyle: { color: "#00eeff" },
              labelColor: "#fff",
              splitLine: { lineStyle: { color: "rgba(0,238,255,0.1)" } },
            },
            series: {
              monitor: {
                name: "è§‚æµ‹å€¼",
                lineStyle: { color: "#00eeff", width: 3 },
                itemStyle: { color: "#00eeff" },
              },
              model: {
                name: "æ¨¡æ‹Ÿå€¼",
                lineStyle: { color: "#ffaa00", width: 3 },
                itemStyle: { color: "#ffaa00" },
              },
            },
          };

          /**
           * è·å–æ—¶é—´åºåˆ—å›¾çš„é…ç½®é¡¹
           * @param {Array} monitorData - è§‚æµ‹æ•°æ® [{date, value}, ...]
           * @param {Array} modelData - æ¨¡æ‹Ÿæ•°æ® [{date, value}, ...]
           * @returns {Object} EChartsé…ç½®é¡¹
           */
          const getStationChartOption = (monitorData, modelData) => {
            // å¤„ç†ç©ºæ•°æ®åœºæ™¯
            const xData = monitorData.map((d) => d.date) || [];

            return {
              title: CHART_STYLES.title,
              tooltip: {
                trigger: "axis",
                confine: true,
                appendToBody: true,
                extraCssText: "z-index: 9999",
                axisPointer: {
                  type: "line",
                  lineStyle: {
                    color: "rgba(255, 255, 255, 0.5)",
                    type: "dashed",
                  },
                },
              },
              legend: CHART_STYLES.legend,
              grid: CHART_STYLES.grid,
              xAxis: {
                type: "category",
                boundaryGap: false,
                data: xData,
                axisLine: CHART_STYLES.axis.lineStyle,
                axisLabel: {
                  color: CHART_STYLES.axis.labelColor,
                  fontSize: 10,
                  formatter: (value) => value.replace('æ—¶', '')
                },
              },
              yAxis: {
                type: "value",
                axisLine: CHART_STYLES.axis.lineStyle,
                axisLabel: {
                  color: CHART_STYLES.axis.labelColor,
                  fontSize: 10,
                },
                splitLine: CHART_STYLES.axis.splitLine,
                name: "å¾®å…‹/ç«‹æ–¹ç±³",
                nameTextStyle: {
                  color: CHART_STYLES.axis.labelColor,
                  fontSize: 10,
                },
                nameGap: 30,
              },
              series: [
                {
                  ...CHART_STYLES.series.monitor,
                  type: "line",
                  data: monitorData.map((d) => d.value) || [],
                  smooth: true,
                  symbol: "circle",
                },
                {
                  ...CHART_STYLES.series.model,
                  type: "line",
                  data: modelData.map((d) => d.value) || [],
                  smooth: true,
                  symbol: "circle",
                },
              ],
            };
          };
          const initStationChart = async () => {
            if (!stationChart.value) {
              stationChart.value = echarts.init(
                stationChartContentRef.value,
                "dark"
              );
            }

            let stationCode = "1001A";
            let startDate = "2024-11-04 00:00";
            let endDate = "2024-11-23 23:00";
            let pollutant = "PM2.5";
            // let monitorData = getMonitorData(
            //   stationCode,
            //   startDate,
            //   endDate,
            //   pollutant
            // );
            // let modelData = getModelData(
            //   stationCode,
            //   startDate,
            //   endDate,
            //   pollutant
            // );
            // console.log("monitorData----",monitorData);
            // console.log("modelData----",modelData);

            const res = await fetch(
              `./ctm_demo_resutl/ctm/task_results/stationChart_options.json`
            ).then((res) => res.json());
            const monitorData = res.monitorData || [];
            const modelData = res.modelData || [];

            let option = getStationChartOption(monitorData, modelData);
            stationChart.value.setOption(option);
          };
          const updateMaskLayer = (ctx) => {
            if (
              !ctx.mapMarkersLayer.value ||
              !ctx.baseMapCorners.value ||
              ctx.baseMapCorners.value.length < 4
            )
              return;
            let chinaArray = [
              [56.132617308505615, 40.98666927775727],
              [56.132617308505615, 169.01333072224276],
              [-1.7735081079264696, 135.08644966659034],
              [-1.7735081079264696, 74.91355033340966],
              [56.132617308505615, 40.98666927775727],
            ];
            let targetArray = [
              [ctx.baseMapCorners.value[0][1], ctx.baseMapCorners.value[0][0]],
              [ctx.baseMapCorners.value[1][1], ctx.baseMapCorners.value[1][0]],
              [ctx.baseMapCorners.value[3][1], ctx.baseMapCorners.value[3][0]],
              [ctx.baseMapCorners.value[2][1], ctx.baseMapCorners.value[2][0]],
              [ctx.baseMapCorners.value[0][1], ctx.baseMapCorners.value[0][0]],
            ];
            console.log("ç›®æ ‡åŒºåŸŸåæ ‡:", targetArray);
            var plyall = L.polygon([chinaArray, targetArray], {
              color: "transparent",
              fillColor: "#0a0a2a",
              fillOpacity: 1,
            });
            ctx.mapMarkersLayer.value.clearLayers();
            ctx.mapMarkersLayer.value.addLayer(plyall);
            if (ctx.mapInstance.value && ctx.mapBounds.value) {
              ctx.mapInstance.value.fitBounds(ctx.mapBounds.value, { maxZoom: 18 });
            }
          };
          const handleMap = async (ctx) => {
            await loadMapData(ctx);
            initMap(ctx);
            await drawBaseMap(ctx);
            updateMaskLayer(ctx);
            focusOnDomain(ctx);
          };
          const handleChart = async () => {
            // await Promise.all([getStationData(), getStationModelData()]);
            await initStationChart();
          };
          const PM25_DICT = {
            PM25_CL: "æ°¯ç¦»å­",
            PM25_EC: "å…ƒç´ ç¢³",
            PM25_NA: "é’ ç¦»å­",
            PM25_MG: "é•ç¦»å­",
            PM25_K: "é’¾ç¦»å­",
            PM25_CA: "é’™ç¦»å­",
            PM25_NH4: "é“µç¦»å­",
            PM25_NO3: "ç¡é…¸ç›",
            PM25_OC: "æœ‰æœºç¢³",
            PM25_OM: "æœ‰æœºç‰©",
            PM25_POM: "ä¸€æ¬¡æœ‰æœºç‰©",
            PM25_SOM: "äºŒæ¬¡æœ‰æœºç‰©",
            PM25_SO4: "ç¡«é…¸ç›",
            PM25_TOT: "æ€»è´¨é‡æµ“åº¦",
          };

          const handlePMChart = async () => {
            try {
              if (!pm25ComponentChart.value) {
                pm25ComponentChart.value = echarts.init(
                  pm25ComponentRef.value,
                  "dark"
                );
              }
              
              // const time = "2024-10-28 00:00:00";
              // let data = await fetch(
              //   `./ctm_demo_resutl/ctm/1_layer_data_cn03_model_avg.json`
              // ).then((res) => res.json());
              // const MAIN_KEYS = [
              //   "PM25_EC",
              //   "PM25_OM",
              //   "PM25_NO3",
              //   "PM25_SO4",
              //   "PM25_NH4",
              //   "PM25_CL",
              // ];
              // const mainResults = [];
              // let otherSum = 0;
              // let otherCount = 0;
              // for (var item of data) {
              //   const { pollutant, date, value } = item;
              //   if (date != time || !pollutant.includes("PM25_")) continue;
              //   if (MAIN_KEYS.includes(pollutant)) {
              //     mainResults.push({
              //       key: pollutant,
              //       name: PM25_DICT[pollutant],
              //       value: Number(value.toFixed(2)),
              //     });
              //   } else {
              //     otherSum += value;
              //     otherCount++;
              //   }
              // }
              // // è®¡ç®—â€œå…¶ä»–â€ç»„åˆ†
              // mainResults.push({
              //   key: "OTHER",
              //   name: "å…¶ä»–",
              //   value: Number((otherSum / otherCount).toFixed(2)),
              // });
              // const totalValue = mainResults.reduce(
              //   (sum, item) => sum + item.value,
              //   0
              // );
              // if (totalValue == 0) return;
              // const filteredData = mainResults.filter((item) => item.value > 0);
              // console.log("filteredData---", filteredData);


              const filteredData = await fetch(
                `./ctm_demo_resutl/ctm/task_results/pm25ComponentChart_options.json`
              ).then((res) => res.json());

              let option = {
                backgroundColor: "transparent",
                tooltip: {
                  trigger: "item",
                  formatter: "{b}: {c} ({d}%)",
                  textStyle: {
                    fontSize: 14,
                  },
                },
                legend: {
                  orient: "vertical",
                  right: 8,
                  top: "middle",
                  textStyle: { color: "#fff", fontSize: 12 },
                  icon: "circle",
                  itemWidth: 12,
                  itemHeight: 12,
                  itemGap: 10,
                },
                series: [
                  {
                    type: "pie",
                    radius: ["40%", "70%"],
                    avoidLabelOverlap: false,
                    itemStyle: {
                      borderRadius: 8,
                      borderColor: "rgba(10, 20, 50, 0.8)",
                      borderWidth: 2,
                    },
                    label: {
                      color: "#fff",
                      formatter: "{b}: {d}%",
                      textStyle: {
                        fontSize: 16, // è®¾ç½®tooltipå­—ä½“å¤§å°ä¸º16px
                      },
                    },
                    labelLine: {
                      lineStyle: { color: "rgba(255, 255, 255, 0.6)" },
                    },
                    data: filteredData.length ? filteredData : data,
                  },
                ],
              };
              pm25ComponentChart.value.setOption(option);
            } catch (error) {
              console.error("è·å–PM2.5ç»„åˆ†æ•°æ®å¤±è´¥:", error);
            } finally {
            }
          };
          onMounted(async () => {
            let loading = ElLoading.service({
              target: ".results-container",
              text: "æ•°æ®åŠ è½½ä¸­...",
              background: "rgba(0, 0, 0, 0.8)",
            });
            await nextTick();
            await Promise.all([
              handleMap(emissionMapCtx),
              handleMap(spatialMapCtx),
              handleChart(),
              handlePMChart(),
            ]);

            loading.close();
          });

          onUnmounted(() => {
            [emissionMapCtx, spatialMapCtx].forEach((ctx) => {
              if (ctx.mapInstance.value) {
                ctx.mapInstance.value.remove();
                ctx.mapInstance.value = null;
              }
            });
            if (stationChart.value) {
              stationChart.value.dispose();
              stationChart.value = null;
            }
          });

          return {
            emissionMapContentRef,
            spatialMapContentRef,
            stationChartContentRef,
            pm25ComponentRef,
            openDetailModule,
          };
        },
      }).mount("#app");
    </script>
    
  </body>
</html>
